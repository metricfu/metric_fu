module MetricFu

  # MetricFu.result memoizes access to a Result object, that will be
  # used throughout the lifecycle of the MetricFu app.
  def self.result
    @result ||= Result.new
  end

  # = Result
  #
  # The Result class is responsible for one thing:
  #
  # It tracks the results generated by each metric used in this test run.
  class Result

    # Renders the result of the result_hash into a yaml serialization
    # ready for writing out to a file.
    #
    # @return YAML
    #   A YAML object containing the results of the result generation
    #   process
    def as_yaml
      result_hash.to_yaml
    end

    def per_file_data
      @per_file_data ||= {}
    end

    def result_hash #:nodoc:
      @result_hash ||= {}
    end

    # Adds a hash from a passed result, produced by one of the Generator
    # classes to the aggregate result_hash managed by this hash.
    #
    # @param result_type Hash
    #   The hash to add to the aggregate result_hash
    def add(result_type)
      mf_debug "result requested #{result_type}"
      clazz = MetricFu.const_get(result_type.to_s.gsub(/\/(.?)/) { "::#{$1.upcase}" }.gsub(/(?:^|_)(.)/) { $1.upcase })
      mf_debug "result class found #{clazz}"
      metric_options = MetricFu.send(result_type)
      inst = clazz.new(metric_options)

      result_hash.merge!(inst.generate_result)

      inst.per_file_info(per_file_data) if inst.respond_to?(:per_file_info)
    end
  end
end
